# Элементарный Telegram-бот, выполняющий основные функции

## Содержание

1. [Бот для поиска ближайших ресторанов быстрого питания](#Бот_для_поиска_ближайших_ресторанов_быстрого_питания)
2. [Основные моменты при реализации](#Основные_моменты_при_реализации)
3. [Реализация поиска заведений и геокодера](#Реализация_поиска_заведений_и_геокодера)

<a name="Бот_для_поиска_ближайших_ресторанов_быстрого_питания"></a>
## Бот для поиска ближайших ресторанов быстрого питания

Программа производит поиск ближайших заведений по отправленному пользователем местоположению или названию станции метро в СПб. Также она предоставляет выбор между _четырьмя_ ресторанами:
 + McDonald’s
 + KFC
 + Subway
 + Burger King
 
Бот присылает местоположение ближайших заведений с помощью точек на картах. Пользователь может выбрать ресторан, наиболее подходящий его требованиям.  

Отправление локаций пользователю оптимизировано и содержит мало сообщений: отправляется одна локация и предоставляется вариант выбора другой, либо же выбора другого ресторана. 

[Видео с функционированием бота](https://drive.google.com/file/d/1--etGkIuulyfVxT6oECJTEflRvLrKDIb/view?usp=sharing)

<a name="Основные_моменты_при_реализации"></a>
## Основные моменты при реализации

Бот написан на языке python 3, с помощью библиотеки pyTelegramBotAPI (документация [Telegram Bot API](https://core.telegram.org/bots/api)). Для реализации бота создано три файла.

В файле _bot_eat.py_ расположены основные функции бота, реагирующие на отклики пользователя. 

Файл _functions.py_ содержит реализации функций, необходимых для корректной работы программы. В нем находятся как функции для реализации работы с картами, так и функции вывода текста и кнопок. 

API-ключи, как и token бота, были помещены в файл _config.py_. Для запуска программы необходимо добавить индивидуальные данные в этот файл.

<a name="Реализация_поиска_заведений_и_геокодера"></a>
## Реализация поиска заведений и геокодера
 
Работа с картами была реализована с помощью сервиса _2gis_ и библиотек requests и json. 2gis не требует подключения нескольких ключей для выполнения разных действий. Для реализации были использованы
+ _**Geocoder API**_
    - Для определения координат станций метро, введенных пользователем. 
    - Использовано в функции func_geo_gis.
    - [Документация Geocoder API для 2gis](https://docs.2gis.com/ru/api/search/geocoder/overview).
    - [Альтернатива при использовании сервисов Яндекс: API Геокодера](https://yandex.ru/dev/maps/geocoder/doc/desc/concepts/about.html).

С помощью библиотеки requests отправляются get-запросы с конкретными параметрами, которые указаны в документации, на сайты, результат возвращается в формате объекта json. 

Пример отправления запроса на сайт config.gis_geo на получение координат объекта query с преобразованием полученного объекта json в список:
```python
query = 'СПб метро ' + message.text 
r = requests.get(url=config.gis_geo, params={
    'q' : query,
    'key': config.API_key_gis,
    'fields' : 'items.point'
}) 
result = json.loads(r.text)
```

Работа с полученными результатами производится согласно документации.
```python
point = str(result['result']['items'][0]['point']['lon']) + ',' + str(result['result']['items'][0]['point']['lat'])
```

+ _**Places API**_ 
    - Для нахождения ближайших заведений на карте по координатам в определенном радиусе. 
    - Использовано в функции func_search_gis.
    - [Документация Places API для 2gis](https://docs.2gis.com/ru/api/search/places/overview).
    - [Альтернатива при использовании сервисов Яндекс: API поиска по организациям](https://yandex.ru/dev/maps/geosearch/doc/concepts/about.html).

Пример отправления запроса на сайт config.gis_search на получение объекта call.data, находящегося в радиусе 1000 метров от точки point с последующем преобразованием в список:
```python
r = requests.get(url=config.gis_search, params={
    'q' : call.data,
    'key': config.API_key_gis,
    'point' : point,
    'type' : 'branch',
    'fields' :'items.point,items.schedule',
    'radius' : '1000'
}) 
result = json.loads(r.text)
```

Результаты, полученные списками из нескольких элементов возможно обрабатывать по разному. Возможно использовать цикл со счетчиком для перебора всех элементов списка.

Пример отправления ботом полученных результатов пользователю через функцию send_venue с помощью перебора циклом for:
```python
for item in result['result']['items']:
    bot.send_venue(call.message.chat.id, item['point']['lat'], item['point']['lon'], item['name'], item['address_name'])
```

Также зная количество полученных элементов возможно производить обработку по одному элементу.
```python
bot.send_venue(chat_id=call.message.chat.id, 
    latitude=result['result']['items'][cnt]['point']['lat'], 
    longitude=result['result']['items'][cnt]['point']['lon'], 
    title=result['result']['items'][cnt]['name'], 
    address=result['result']['items'][cnt]['address_name'])
```
